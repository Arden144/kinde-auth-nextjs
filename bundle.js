"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),r=require("crypto-js");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=t(e);const a={user:null,isAuthenticated:!1,isLoading:!0,checkSession:null},o=()=>{throw new Error("Oops! Seems like you forgot to wrap your app in <KindeProvider>.")},n=e.createContext({...a,user:o,isLoading:o,isAuthenticated:o,checkSession:o});const c=new URL(`https://${process.env.KINDE_REDIRECT_URL}/api/auth/kinde_callback`),i=new URL(`https://${process.env.KINDE_DOMAIN}/logout`),d=new URL(`https://${process.env.KINDE_DOMAIN}/oauth2/token`),u=e=>{const r=new URL(`https://${process.env.KINDE_DOMAIN}/oauth2/auth`);return r.searchParams.append("response_type","code"),r.searchParams.append("client_id","reg@live"),r.searchParams.append("redirect_uri",c),r.searchParams.append("scope","openid offline"),e&&r.searchParams.append("start_page","registration"),r},h=u(),l=u(!0),p=require("crypto"),_=()=>p.randomBytes(28).toString("hex");function g(){const e=_(),t=function(e){return r.SHA256(e).toString(r.enc.Base64url)}(e);return{code_verifier:e,code_challenge:t}}var f=require("cookie");const y=(e,r,t)=>{const s=_(),{code_challenge:a,code_verifier:o}=g();return r.setHeader("Set-Cookie",f.serialize(`pkce-verifier-${s}`,o,{httpOnly:!0,maxAge:t})),{state:s,code_challenge:a}};var v=require("cookie");var k=require("cookie");var w=require("cookie");exports.AuthContext=n,exports.KindeProvider=({children:r,initialUser:t})=>{const[o,c]=e.useState({...a,user:t,isLoading:!t,isAuthenticated:!!t}),i="/api/auth/me",d=e.useCallback((async()=>{try{const e=await(async e=>{let r;try{r=await fetch(e)}catch{throw new RequestError(0)}if(r.ok)return r.json();r.status})(i);c((r=>({...r,user:e,error:void 0})))}catch(e){c((r=>({...r,error:e})))}}),[i]);e.useEffect((()=>{o.user||(async()=>{await d(),c((e=>({...e,isLoading:!1})))})()}),[o.user]);const{user:u,error:h,isLoading:l,isAuthenticated:p}=o;return s.default.createElement(n.Provider,{value:{user:u,error:h,isLoading:l,isAuthenticated:p}},r)},exports.handleAuth=()=>async function(e,r){let{query:{kindeAuth:t}}=e;switch(t=Array.isArray(t)?t[0]:t,t){case"login":return await(async(e,r)=>{const{state:t,code_challenge:s}=y(0,r,60);h.searchParams.set("state",t),h.searchParams.set("code_challenge",s),h.searchParams.set("code_challenge_method","S256"),r.redirect(h.href)})(0,r);case"register":return await(async(e,r)=>{const{state:t,code_challenge:s}=y(0,r,180);l.searchParams.set("state",t),l.searchParams.set("code_challenge",s),l.searchParams.set("code_challenge_method","S256"),r.redirect(l.href)})(0,r);case"me":return await(async(e,r)=>{const t=k.parse(e.headers.cookie||"").kinde_token,s=JSON.parse(t);if(t)try{const e=await fetch(`https://${process.env.KINDE_DOMAIN}/oauth2/user_profile`,{headers:new Headers({Authorization:"Bearer "+s.access_token})}),t=await e.json();r.send(t),console.log(t)}catch(e){console.log(e)}r.end()})(e,r);case"logout":return await(async(e,r)=>{r.setHeader("Set-Cookie",v.serialize("kinde_token",null,{httpOnly:!0,maxAge:0})),i.searchParams.set("redirect",process.env.KINDE_LOGOUT_URL?`https://${process.env.KINDE_LOGOUT_URL}`:`https://${process.env.KINDE_REDIRECT_URL}`),r.redirect(i.href)})(0,r);case"kinde_callback":return await(async(e,r)=>{const{code:t,state:s}=e.query,a=w.parse(e.headers.cookie||"")[`pkce-verifier-${s}`];if(a){try{const e=await fetch(d,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"}),body:new URLSearchParams({client_id:process.env.CLIENT_ID,client_secret:process.env.CLIENT_SECRET,code:t,code_verifier:a,grant_type:"authorization_code",redirect_uri:c})}),s=await e.json();console.log(s),r.setHeader("Set-Cookie",w.serialize("kinde_token",JSON.stringify(s),{httpOnly:!0,maxAge:Number(s.expires_in)}))}catch(e){console.log(e)}r.redirect(`https://${process.env.KINDE_REDIRECT_URL}`)}else r.redirect(`https://${process.env.KINDE_REDIRECT_URL}`)})(e,r);default:return r.status(404).end()}},exports.useAuth=()=>e.useContext(n);
