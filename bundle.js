"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("crypto-js");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=r(e);const a={user:null,isAuthenticated:!1,isLoading:!0,checkSession:null},n=()=>{throw new Error("Oops! Seems like you forgot to wrap your app in <KindeProvider>.")},o=e.createContext({...a,user:n,isLoading:n,isAuthenticated:n,checkSession:n});const c=new URL(`https://${process.env.KINDE_REDIRECT_URL}/api/auth/kinde_callback`),i=new URL(`https://${process.env.KINDE_DOMAIN}/logout`),d=new URL(`https://${process.env.KINDE_DOMAIN}/oauth2/token`),u=e=>{const t=new URL(`https://${process.env.KINDE_DOMAIN}/oauth2/auth`);return t.searchParams.append("response_type","code"),t.searchParams.append("client_id","reg@live"),t.searchParams.append("redirect_uri",c),t.searchParams.append("scope","openid offline"),e&&t.searchParams.append("start_page","registration"),t},h=u(),l=u(!0),p=require("crypto"),_=()=>p.randomBytes(28).toString("hex");function f(){const e=_(),r=function(e){return t.SHA256(e).toString(t.enc.Base64url)}(e);return{code_verifier:e,code_challenge:r}}var g=require("cookie");const y=(e,t,r)=>{const s=_(),{code_challenge:a,code_verifier:n}=f();return t.setHeader("Set-Cookie",g.serialize(`pkce-verifier-${s}`,n,{httpOnly:!0,maxAge:r})),{state:s,code_challenge:a}};var v=require("cookie");var k=require("cookie");var w=require("cookie");exports.AuthContext=o,exports.KindeProvider=({children:t,initialUser:r})=>{const[n,c]=e.useState({...a,user:r,isLoading:!r,isAuthenticated:!!r}),i="/api/auth/me",d=e.useCallback((async()=>{try{const e=await(async e=>{let t;try{t=await fetch(e)}catch{throw new RequestError(0)}if(t.ok)return t.json();t.status})(i);c((t=>({...t,user:e,error:void 0})))}catch(e){c((t=>({...t,error:e})))}}),[i]);e.useEffect((()=>{n.user||(async()=>{await d(),c((e=>({...e,isLoading:!1})))})()}),[n.user]);const{user:u,error:h,isLoading:l,isAuthenticated:p}=n;return s.default.createElement(o.Provider,{value:{user:u,error:h,isLoading:l,isAuthenticated:p}},t)},exports.handleAuth=()=>async function(e,t){let{query:{kindeAuth:r}}=e;switch(r=Array.isArray(r)?r[0]:r,r){case"login":return await(async(e,t)=>{const{state:r,code_challenge:s}=y(0,t,60);h.searchParams.set("state",r),h.searchParams.set("code_challenge",s),h.searchParams.set("code_challenge_method","S256"),t.redirect(h.href)})(0,t);case"register":return await(async(e,t)=>{const{state:r,code_challenge:s}=y(0,t,180);l.searchParams.set("state",r),l.searchParams.set("code_challenge",s),l.searchParams.set("code_challenge_method","S256"),t.redirect(l.href)})(0,t);case"me":return await(async(e,t)=>{const r=k.parse(e.headers.cookie||"").kinde_token;if(r){const e=JSON.parse(r);try{const r=await fetch(`https://${process.env.KINDE_DOMAIN}/oauth2/user_profile`,{headers:new Headers({Authorization:"Bearer "+e.access_token})}),s=await r.json();t.send(s)}catch(e){console.log(e)}}else t.status(401).send("Unauthorized")})(e,t);case"logout":return await(async(e,t)=>{t.setHeader("Set-Cookie",v.serialize("kinde_token",null,{httpOnly:!0,maxAge:0})),i.searchParams.set("redirect",process.env.KINDE_LOGOUT_URL?`https://${process.env.KINDE_LOGOUT_URL}`:`https://${process.env.KINDE_REDIRECT_URL}`),t.redirect(i.href)})(0,t);case"kinde_callback":return await(async(e,t)=>{const{code:r,state:s}=e.query,a=w.parse(e.headers.cookie||"")[`pkce-verifier-${s}`];if(a){try{const e=await fetch(d,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"}),body:new URLSearchParams({client_id:process.env.CLIENT_ID,client_secret:process.env.CLIENT_SECRET,code:r,code_verifier:a,grant_type:"authorization_code",redirect_uri:c})}),s=await e.json();t.setHeader("Set-Cookie",w.serialize("kinde_token",JSON.stringify(s),{httpOnly:!0,maxAge:Number(s.expires_in)}))}catch(e){console.log(e)}t.redirect(`https://${process.env.KINDE_REDIRECT_URL}`)}else t.redirect(`https://${process.env.KINDE_REDIRECT_URL}`)})(e,t);default:return t.status(404).end()}},exports.useAuth=()=>e.useContext(o);
