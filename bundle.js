"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("crypto-js");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=r(e);const a=process.env.KINDE_REDIRECT_URL,i=process.env.KINDE_ISSUER_URL,c=process.env.KINDE_POST_LOGOUT_REDIRECT_ROUTE,o={initialState:{user:null,isAuthenticated:!1,isLoading:!0,checkSession:null},SESSION_PREFIX:"pkce-verifier",redirectURL:a,issuerURL:i,clientID:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,responseType:"code",scope:"openid offline",codeChallengeMethod:"S256",redirectRoutes:{callback:"/api/auth/kinde_callback",postLogoutRedirect:c||"/"},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/user_profile"}},n=()=>{throw new Error("Oops! Seems like you forgot to wrap your app in <KindeProvider>.")},u=e.createContext({...o.initialState,user:n,isLoading:n,isAuthenticated:n,checkSession:n});const d=require("crypto"),l=()=>d.randomBytes(28).toString("hex");function h(){const e=l(),r=function(e){return t.SHA256(e).toString(t.enc.Base64url)}(e);return{code_verifier:e,code_challenge:r}}var p=require("cookie");const _=(e,t,r)=>{const s=l(),{code_challenge:a,code_verifier:i}=h();return t.setHeader("Set-Cookie",p.serialize(`${o.SESSION_PREFIX}-${s}`,i,{httpOnly:!0,maxAge:r})),{state:s,code_challenge:a}};var R=require("cookie");var g=require("cookie");var y=require("cookie");exports.AuthContext=u,exports.KindeProvider=({children:t,initialUser:r})=>{const[a,i]=e.useState({...o.initialState,user:r,isLoading:!r,isAuthenticated:!!r}),c="/api/auth/me",n=e.useCallback((async()=>{try{const e=await(async e=>{let t;try{t=await fetch(e)}catch{throw new RequestError(0)}if(t.ok)return t.json();t.status})(c);i((t=>({...t,user:e,error:void 0})))}catch(e){i((t=>({...t,error:e})))}}),[c]);e.useEffect((()=>{a.user||((async()=>{await n(),i((e=>({...e,isLoading:!1,isAuthenticated:!0})))})(),i((e=>({...e,isAuthenticated:!1}))))}),[a.user]);const{user:d,error:l,isLoading:h,isAuthenticated:p}=a;return s.default.createElement(u.Provider,{value:{user:d,error:l,isLoading:h,isAuthenticated:p}},t)},exports.handleAuth=()=>async function(e,t){let{query:{kindeAuth:r}}=e;switch(r=Array.isArray(r)?r[0]:r,r){case"login":return await(async(e,t)=>{const{state:r,code_challenge:s}=_(0,t,60),a=new URL(o.issuerURL+o.issuerRoutes.login);a.searchParams.append("response_type",o.responseType),a.searchParams.append("client_id",o.clientID),a.searchParams.append("redirect_uri",o.redirectURL+o.redirectRoutes.callback),a.searchParams.append("scope",o.scope),a.searchParams.set("state",r),a.searchParams.set("code_challenge",s),a.searchParams.set("code_challenge_method",o.codeChallengeMethod),t.redirect(a.href)})(0,t);case"register":return await(async(e,t)=>{const{state:r,code_challenge:s}=_(0,t,180),a=new URL(o.issuerURL+o.issuerRoutes.register);a.searchParams.append("response_type",o.responseType),a.searchParams.append("client_id",o.clientID),a.searchParams.append("redirect_uri",o.redirectURL+o.redirectRoutes.callback),a.searchParams.append("scope",o.scope),a.searchParams.append("start_page","registration"),a.searchParams.set("state",r),a.searchParams.set("code_challenge",s),a.searchParams.set("code_challenge_method",o.codeChallengeMethod),t.redirect(a.href)})(0,t);case"me":return await(async(e,t)=>{const r=g.parse(e.headers.cookie||"").kinde_token;if(r){const e=JSON.parse(r);try{const r=await fetch(o.issuerURL+o.issuerRoutes.profile,{headers:new Headers({Authorization:"Bearer "+e.access_token})}),s=await r.json();t.send(s)}catch(e){console.log(e)}}else t.status(401).send("Unauthorized")})(e,t);case"logout":return await(async(e,t)=>{t.setHeader("Set-Cookie",R.serialize("kinde_token",null,{httpOnly:!0,maxAge:0}));const r=new URL(o.issuerURL+o.issuerRoutes.logout);r.searchParams.set("redirect",o.redirectURL+o.redirectRoutes.postLogoutRedirect),t.redirect(r.href)})(0,t);case"kinde_callback":return await(async(e,t)=>{const{code:r,state:s}=e.query,a=y.parse(e.headers.cookie||"")[`${o.SESSION_PREFIX}-${s}`];if(a){try{const e=await fetch(o.issuerURL+o.issuerRoutes.token,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"}),body:new URLSearchParams({client_id:o.clientID,client_secret:o.clientSecret,code:r,code_verifier:a,grant_type:"authorization_code",redirect_uri:o.redirectURL+o.redirectRoutes.callback})}),s=await e.json();t.setHeader("Set-Cookie",y.serialize("kinde_token",JSON.stringify(s),{httpOnly:!0,maxAge:Number(s.expires_in)}))}catch(e){console.log(e)}t.redirect(o.redirectURL)}else t.redirect(o.redirectURL)})(e,t);default:return t.status(404).end()}},exports.useKindeAuth=()=>e.useContext(u);
